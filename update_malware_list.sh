#!/bin/bash

# Définir le chemin du fichier full_sha256.txt dans le répertoire actuel
MALWARE_LIST_FILE="./full_sha256.txt"

# Emplacement du fichier malware dans /var/ossec/etc/lists
OUTPUT_FILE="/var/ossec/etc/lists/malware"

# Vérifier si le fichier full_sha256.txt existe dans le répertoire actuel
if [ ! -f "$MALWARE_LIST_FILE" ]; then
    echo "Le fichier $MALWARE_LIST_FILE est introuvable. Assurez-vous qu'il est dans le répertoire actuel."
    exit 1
fi

# Créer le répertoire si nécessaire
if [ ! -d "/var/ossec/etc/lists" ]; then
    echo "Le répertoire /var/ossec/etc/lists n'existe pas. Création du répertoire..."
    sudo mkdir -p /var/ossec/etc/lists
fi

# Formater la liste des hashes avec un deux-points à la fin de chaque ligne
echo "Formatage des hashes en ajoutant un deux-points..."
awk '!/^#/{print $1":";}' "$MALWARE_LIST_FILE" > "$OUTPUT_FILE"

# Si la commande AWK ne fonctionne pas, utiliser la commande alternative
if [ $? -ne 0 ]; then
    echo "La première commande AWK a échoué. Utilisation de la commande alternative..."
    awk '/^[^#]/{sub(/\r$/, ""); print $0 ":"}' "$MALWARE_LIST_FILE" > "$OUTPUT_FILE"
fi

# Vérifier si le fichier malware a été créé correctement
if [ -f "$OUTPUT_FILE" ]; then
    echo "Les hashes ont été formatés et enregistrés avec succès dans le fichier $OUTPUT_FILE."
else
    echo "Erreur lors de la création du fichier $OUTPUT_FILE."
    exit 1
fi

# Afficher un message de succès
echo "Script terminé avec succès. Le fichier $OUTPUT_FILE contenant les hashes formatés est prêt."

